@{
    Layout = null;
    string statusVN = Model.movie.status switch
    {
        "ongoing" => "Đang chiếu",
        "completed" => "Hoàn thành",
        "trailer" => "Trailer",
        _ => "Đang cập nhật"
    };

    string trailerUrl = Model.movie.trailer_url;
    if (string.IsNullOrEmpty(trailerUrl) && Model.movie.slug == "quy-nhap-trang-2")
    {
        trailerUrl = "https://www.youtube.com/watch?v=q0UWKBzFFxQ";
    }
}
@model MovieDetailResponse

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@Model.movie.name</title>
    <link rel="stylesheet" href="/css/movie.css" />
    <link rel="stylesheet" href="/css/detail.css" />
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest/dist/hls.min.js"></script>

</head>
<body data-movie-slug="@ViewBag.MovieId"
      data-movie-name="@Model.movie.name"
      data-movie-poster="@Model.movie.poster_url"
      data-movie-year="@Model.movie.year">

    @Html.Partial("_Header")

    <div class="detail-container">

        <div class="detail-left">
            <img src="@Model.movie.poster_url"
                 onerror="this.src='https://via.placeholder.com/300x450'" />
        </div>

        <div class="detail-right">
            <h1>@Model.movie.name</h1>

            <div class="movie-actions" style="margin-bottom: 30px;">
                <button id="saveMovieBtn" onclick="toggleSaveMovie()">
                    <span class="icon">♡</span>
                    <span class="text">Thêm vào danh sách</span>
                </button>
                @if (!string.IsNullOrEmpty(trailerUrl))
                {
                    <button class="trailer-btn" onclick="openTrailer('@trailerUrl')">
                        <svg viewBox="0 0 24 24" fill="white" style="width:16px;height:16px;margin-right:6px;vertical-align:middle"><path d="M8 5v14l11-7z"/></svg>
                        Xem Trailer
                    </button>
                }
            </div>
            <p>
                <strong>Thể loại:</strong>
                @if (Model.movie.category != null && Model.movie.category.Any())
                {
                    @string.Join(", ", Model.movie.category.Select(c => c.name))
                }
                else
                {
                    <span>Đang cập nhật</span>
                }
            </p>

            <p><strong>Năm:</strong> @Model.movie.year</p>
            <p><strong>Trạng thái:</strong> @statusVN</p>

            <div class="movie-description">
                <h3>Nội dung phim</h3>
                <div class="description-content" id="movieContent" style="display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis;">
                    @Html.Raw(Model.movie.content)
                </div>
            </div>
            <script>
            function toggleContent() {
                const content = document.getElementById("movieContent");
                const btn = document.querySelector(".toggle-content");

                content.classList.toggle("collapsed");

                btn.innerText = content.classList.contains("collapsed")
                    ? "Xem thêm"
                    : "Thu gọn";
            }
            </script>

            <script>
            // ===== MY LIST =====
                function getMyList() {
                    try {
                        return JSON.parse(localStorage.getItem('myList')) || [];
                    } catch {
                        return [];
                    }
                }

                function saveMyList(list) {
                    localStorage.setItem('myList', JSON.stringify(list));
                }

                function toggleSaveMovie() {
                    let list = getMyList();
                    const btn = document.getElementById("saveMovieBtn");

                    const existingIndex = list.findIndex(m => m.slug === movieSlug);

                    if (existingIndex !== -1) {
                        // Remove movie
                        list.splice(existingIndex, 1);
                        btn.classList.remove("saved");
                        btn.innerText = "+ Thêm vào danh sách";
                        showToast("Đã xóa khỏi Danh Sách ❌", "remove");
                    } else {
                        // Add movie
                        const movieData = {
                            slug: movieSlug,
                            name: movieName,
                            poster: moviePoster,
                            year: movieYear,
                            savedAt: Date.now()
                        };

                        list.unshift(movieData);

                        if (list.length > 50) {
                            list = list.slice(0, 50);
                        }

                        btn.classList.add("saved");
                        btn.innerText = "✓ Đã lưu";
                        showToast("Đã thêm vào Danh Sách ❤️", "success");
                    }

                    saveMyList(list);
                }

                // ===== CHECK ON LOAD =====
                function checkIfSaved() {
                    const list = getMyList();
                    const btn = document.getElementById("saveMovieBtn");

                    if (list.some(m => m.slug === movieSlug)) {
                        btn.classList.add("saved");
                        btn.innerText = "✓ Đã lưu";
                    }
                }

                document.addEventListener("DOMContentLoaded", function () {
                    checkIfSaved();
                });

            </script>

            <script>
            // ===== TRAILER =====
            function openTrailer(url) {
                // Convert YouTube watch URL to embed URL
                let embedUrl = url;
                const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/);
                if (ytMatch) embedUrl = 'https://www.youtube.com/embed/' + ytMatch[1] + '?autoplay=1&rel=0';
                document.getElementById('trailerFrame').src = embedUrl;
                const modal = document.getElementById('trailerModal');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            function closeTrailer() {
                document.getElementById('trailerFrame').src = '';
                document.getElementById('trailerModal').style.display = 'none';
                document.body.style.overflow = '';
            }
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeTrailer();
            });
            document.getElementById('trailerModal').addEventListener('click', function(e) {
                if (e.target === this) closeTrailer();
            });
            </script>
        </div>

    </div>

    <!-- Trailer Modal -->
    <div id="trailerModal" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;">
        <div style="position:relative;width:90%;max-width:920px;aspect-ratio:16/9;">
            <button onclick="closeTrailer()" style="position:absolute;top:-40px;right:0;background:none;border:none;color:#fff;font-size:28px;cursor:pointer;line-height:1;">&#x2715;</button>
            <iframe id="trailerFrame" src="" allow="autoplay;fullscreen" allowfullscreen
                style="width:100%;height:100%;border:none;border-radius:8px;"></iframe>
        </div>
    </div>

    <div class="episode-section">
        <h2>Danh sách tập</h2>

        @{
            int index = 0;
        }

        @foreach (var server in Model.episodes)
        {
            <h3>@server.server_name</h3>

            @foreach (var ep in server.server_data)
            {
                <button class="episode-btn"
                        data-index="@index"
                        data-url="@ep.link_embed"
                        data-name="@ep.name"
                        onclick="playMovie(this, @index)">
                    @ep.name
                </button>

                index++;
            }
        }
    </div>

    <div class="now-watching">
        Bạn đang xem: Tập <span id="currentEpisodeName">Chưa chọn tập</span>
    </div>

    <!-- Custom Video Player -->
    <div class="player-container" id="playerContainer">
        <div class="player-wrapper" id="playerWrapper">

            <!-- Video element -->
            <video id="videoEl" playsinline></video>

            <!-- Overlay controls (click to show/hide) -->
            <div class="vid-overlay" id="vidOverlay">

                <!-- Top bar: title -->
                <div class="vid-top">
                    <span id="vidTitle">Chưa chọn tập</span>
                </div>

                <!-- Center controls -->
                <div class="vid-center">
                    <button class="vid-btn" onclick="seekBy(-10)" title="Lùi 10s">
                        <svg viewBox="0 0 24 24" fill="white"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/><text x="12" y="15" text-anchor="middle" font-size="5.5" font-weight="bold" fill="white">10</text></svg>
                    </button>
                    <button class="vid-btn" onclick="prevEpisode()" title="Tập trước">
                        <svg viewBox="0 0 24 24" fill="white"><path d="M6 6h2v12H6zm3.5 6L18 6v12z"/></svg>
                    </button>
                    <button class="vid-btn vid-play" id="playBtn" onclick="togglePlay()">
                        <svg id="iconPlay" viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="iconPause" viewBox="0 0 24 24" fill="white" style="display:none"><path d="M6 19h4V5H6zm8-14v14h4V5z"/></svg>
                    </button>
                    <button class="vid-btn" onclick="nextEpisode()" title="Tập sau">
                        <svg viewBox="0 0 24 24" fill="white"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                    </button>
                    <button class="vid-btn" onclick="seekBy(10)" title="Tiến 10s">
                        <svg viewBox="0 0 24 24" fill="white"><path d="M12 5V1l5 5-5 5V7c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6h2c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8z"/><text x="12" y="15" text-anchor="middle" font-size="5.5" font-weight="bold" fill="white">10</text></svg>
                    </button>
                </div>

                <!-- Bottom bar -->
                <div class="vid-bottom">
                    <!-- Progress row -->
                    <div class="vid-progress-row">
                        <div class="vid-progress-wrap" id="progressWrap">
                            <div class="vid-progress-bg">
                                <div class="vid-progress-fill" id="progressFill"></div>
                                <div class="vid-progress-thumb" id="progressThumb"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Controls row -->
                    <div class="vid-controls-row">
                        <!-- Left: play, volume, time -->
                        <div class="vid-ctrl-left">
                            <button class="vid-sm-btn" onclick="togglePlay()">
                                <svg id="iconPlay2" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                <svg id="iconPause2" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6zm8-14v14h4V5z"/></svg>
                            </button>
                            <div class="vid-vol-wrap">
                                <button class="vid-sm-btn" onclick="toggleMute()" id="volBtn">
                                    <svg id="iconVolOn" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                                    <svg id="iconVolOff" viewBox="0 0 24 24" style="display:none"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
                                </button>
                                <div class="vid-vol-slider">
                                    <input type="range" id="volRange" min="0" max="1" step="0.05" value="1"
                                           oninput="setVol(this.value)" style="accent-color:#e50914;width:70px;">
                                </div>
                            </div>
                            <span class="vid-time"><span id="timeCurrent">0:00</span> / <span id="timeDuration">0:00</span></span>
                        </div>
                        <!-- Right: speed, PIP, fullscreen -->
                        <div class="vid-ctrl-right">
                            <!-- Quality Menu -->
                            <div class="vid-speed-wrap">
                                <button class="vid-sm-btn vid-speed-btn" onclick="toggleQualityMenu()" id="btnQuality" title="Chất lượng">
                                    <svg viewBox="0 0 24 24"><path d="M19 8H5c-1.66 0-3 1.34-3 3v2c0 1.66 1.34 3 3 3h14c1.66 0 3-1.34 3-3v-2c0-1.66-1.34-3-3-3zm-9 6H8v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg>
                                    <span id="qualityLabel">Auto</span>
                                </button>
                                <div class="vid-speed-menu" id="qualityMenu" style="display:none">
                                    <div class="vid-speed-title">Chất lượng</div>
                                    <div id="qualityList">
                                        <button onclick="setQuality(-1, this)" class="active-speed">Auto</button>
                                    </div>
                                </div>
                            </div>
                            <!-- Speed Menu -->
                            <div class="vid-speed-wrap">
                                <button class="vid-sm-btn vid-speed-btn" onclick="toggleSpeedMenu()" title="Tốc độ">
                                    <svg viewBox="0 0 24 24"><path d="M20.38 8.57l-1.23 1.85a8 8 0 0 1-.22 7.58H5.07A8 8 0 0 1 15.58 6.85l1.85-1.23A10 10 0 0 0 3.35 19a2 2 0 0 0 1.72 1h13.85a2 2 0 0 0 1.74-1 10 10 0 0 0-.27-10.44zM13 13.66V4h-2v9.66l-1.42-1.42L8.14 13.7 12 17.56l3.86-3.85-1.44-1.44z"/></svg>
                                    <span id="speedLabel">1x</span>
                                </button>
                                <div class="vid-speed-menu" id="speedMenu" style="display:none">
                                    <div class="vid-speed-title">Tốc độ phát</div>
                                    <button onclick="setSpeed(0.5,this)">0.5x</button>
                                    <button onclick="setSpeed(0.75,this)">0.75x</button>
                                    <button onclick="setSpeed(1,this)" class="active-speed">Bình thường</button>
                                    <button onclick="setSpeed(1.25,this)">1.25x</button>
                                    <button onclick="setSpeed(1.5,this)">1.5x</button>
                                    <button onclick="setSpeed(2,this)">2x</button>
                                </div>
                            </div>
                            <button class="vid-sm-btn" onclick="togglePIP()" title="PIP">
                                <svg viewBox="0 0 24 24"><path d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3C1.9 3 1 3.88 1 4.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 0H3V5h18v14z"/></svg>
                            </button>
                            <button class="vid-sm-btn" onclick="toggleFS()" title="Toàn màn hình">
                                <svg id="iconFS" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7zm-2-4h2V7h3V5H5zm12 7h-3v2h5v-5h-2zM14 5v2h3v3h2V5z"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading spinner -->
            <div class="vid-loading" id="vidLoading">
                <div class="vid-spinner"></div>
            </div>
        </div>

        <div class="player-controls">
            <button onclick="prevEpisode()">&#9198; Trước</button>
            <button onclick="toggleCinemaMode()">Rạp phim</button>
            <button onclick="nextEpisode()">Sau &#9197;</button>
        </div>
    </div>

    <!-- Related Movies Section -->
    @if (ViewBag.RelatedMovies != null && ((List<MovieItem>)ViewBag.RelatedMovies).Any())
    {
        <div class="related-movies-section">
            <h2>Phim Cùng Thể Loại</h2>
            <div class="movie-container">
                @foreach (var item in (List<MovieItem>)ViewBag.RelatedMovies)
                {
                    <div class="movie-card">
                        <a href="/Movie/Detail/@item.slug">
                            <img src="https://img.ophim.live/uploads/movies/@item.poster_url"
                                 alt="@item.name"
                                 onerror="this.src='https://placehold.co/300x450?text=No+Image'" />
                        </a>
                        <div class="movie-info">
                            <h4>@item.name</h4>
                            <p>@item.year</p>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <style>
    .player-wrapper { position:relative; width:100%; aspect-ratio:16/9; background:#000; overflow:hidden; }
    #videoEl { width:100%; height:100%; display:block; background:#000; }

    /* Overlay */
    .vid-overlay {
        position:absolute; inset:0;
        display:flex; flex-direction:column; justify-content:space-between;
        background: linear-gradient(to bottom, rgba(0,0,0,0.55) 0%, transparent 25%, transparent 65%, rgba(0,0,0,0.85) 100%);
        opacity:0; transition:opacity 0.3s; pointer-events:none;
    }
    .vid-overlay.show { opacity:1; pointer-events:all; }
    .vid-top { padding:14px 18px; color:#fff; font-size:14px; font-weight:500; }
    .vid-center { display:flex; align-items:center; justify-content:center; gap:clamp(14px,4vw,38px); }
    .vid-btn {
        background:rgba(255,255,255,0.15); border:none; border-radius:50%;
        width:clamp(40px,7vw,64px); height:clamp(40px,7vw,64px);
        display:flex; align-items:center; justify-content:center;
        cursor:pointer; transition:background 0.2s;
    }
    .vid-btn:hover { background:rgba(255,255,255,0.28); }
    .vid-btn svg { width:55%; height:55%; }
    .vid-btn.vid-play { width:clamp(52px,9vw,80px); height:clamp(52px,9vw,80px); background:rgba(255,255,255,0.22); }

    /* Bottom bar */
    .vid-bottom { padding: 0 12px 10px; }

    /* Progress bar */
    .vid-progress-row { padding: 6px 0 4px; cursor:pointer; }
    .vid-progress-wrap { padding: 6px 0; }
    .vid-progress-bg {
        position:relative; height:4px; background:rgba(255,255,255,0.25);
        border-radius:2px; transition:height 0.15s;
    }
    .vid-progress-wrap:hover .vid-progress-bg { height:6px; }
    .vid-progress-fill {
        position:absolute; left:0; top:0; height:100%;
        background:#e50914; border-radius:2px; width:0%;
    }
    .vid-progress-thumb {
        position:absolute; top:50%; transform:translate(-50%,-50%) scale(0);
        width:14px; height:14px; background:#e50914;
        border-radius:50%; transition:transform 0.15s; left:0%;
    }
    .vid-progress-wrap:hover .vid-progress-thumb { transform:translate(-50%,-50%) scale(1); }

    /* Controls row */
    .vid-controls-row { display:flex; align-items:center; justify-content:space-between; }
    .vid-ctrl-left, .vid-ctrl-right { display:flex; align-items:center; gap:6px; }
    .vid-sm-btn {
        background:none; border:none; cursor:pointer; padding:4px;
        display:flex; align-items:center; gap:4px; color:#fff;
    }
    .vid-sm-btn svg { width:20px; height:20px; fill:white; }
    .vid-sm-btn:hover svg { fill:#e50914; }
    .vid-time { color:#fff; font-size:13px; white-space:nowrap; }

    /* Volume */
    .vid-vol-wrap { display:flex; align-items:center; }
    .vid-vol-slider { width:0; overflow:hidden; transition:width 0.2s; }
    .vid-vol-wrap:hover .vid-vol-slider { width:80px; }

    /* Speed menu */
    .vid-speed-wrap { position:relative; }
    .vid-speed-btn { font-size:12px; }
    .vid-speed-menu {
        position:absolute; bottom:calc(100% + 8px); right:0;
        background:#1a1a1a; border:1px solid rgba(255,255,255,0.12);
        border-radius:8px; padding:8px 0; min-width:130px;
        z-index:10; box-shadow:0 8px 24px rgba(0,0,0,0.6);
    }
    .vid-speed-title {
        color:#aaa; font-size:11px; padding:4px 14px 6px;
        border-bottom:1px solid rgba(255,255,255,0.08); margin-bottom:4px;
    }
    .vid-speed-menu button {
        display:block; width:100%; background:none; border:none;
        color:#fff; font-size:13px; padding:7px 14px; text-align:left;
        cursor:pointer;
    }
    .vid-speed-menu button:hover, .vid-speed-menu button.active-speed { color:#e50914; }

    /* Loading spinner */
    .vid-loading { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:#000; z-index:3; pointer-events:none; }
    .vid-loading.hidden { display:none; }
    .vid-spinner { width:44px; height:44px; border:3px solid rgba(255,255,255,0.15); border-top-color:#e50914; border-radius:50%; animation: vspin 0.8s linear infinite; }
    @@keyframes vspin { to { transform:rotate(360deg); } }
    </style>

    <script>
    // ===== STATE =====
    let currentIndex = 0;
    let episodeButtons = [];
    let hls = null;
    let overlayTimer = null;
    let isDragging = false;
    let wasPaused = true;
    let prefetchPromise = null;

    const body     = document.body;
    const movieSlug  = body.dataset.movieSlug;
    const movieName  = body.dataset.movieName;
    const moviePoster= body.dataset.moviePoster;
    const movieYear  = parseInt(body.dataset.movieYear) || 0;

    const videoEl    = document.getElementById('videoEl');
    const overlay    = document.getElementById('vidOverlay');
    const loadingEl  = document.getElementById('vidLoading');
    const progressFill  = document.getElementById('progressFill');
    const progressThumb = document.getElementById('progressThumb');
    const progressWrap  = document.getElementById('progressWrap');
    const timeCur    = document.getElementById('timeCurrent');
    const timeDur    = document.getElementById('timeDuration');

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', function () {
        episodeButtons = document.querySelectorAll('.episode-btn');

        // Initial play (pre-fetch is handled inside playMovie)
        const history = getWatchHistory();
        const saved = history.find(i => i.slug === movieSlug);
        if (saved && episodeButtons[saved.episodeIndex]) {
            playMovie(episodeButtons[saved.episodeIndex], saved.episodeIndex, false);
        } else if (episodeButtons.length > 0) {
            playMovie(episodeButtons[0], 0, false);
        }

        // Video events
        videoEl.addEventListener('timeupdate', onTimeUpdate);
        videoEl.addEventListener('loadedmetadata', onMeta);
        videoEl.addEventListener('waiting', () => loadingEl.classList.remove('hidden'));
        videoEl.addEventListener('playing', () => loadingEl.classList.add('hidden'));
        videoEl.addEventListener('play',  updatePlayIcon);
        videoEl.addEventListener('pause', updatePlayIcon);
        videoEl.addEventListener('ended', nextEpisode);

        // Progress bar dragging
        function getPct(e) {
            const r = progressWrap.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
            return Math.max(0, Math.min(1, x / r.width));
        }
        function handleDragStart(e) {
            isDragging = true;
            wasPaused = videoEl.paused;
            videoEl.pause();
            const pct = getPct(e);
            updateProgress(pct);
            if (videoEl.duration) timeCur.innerText = fmtTime(pct * videoEl.duration);
        }
        function handleDragMove(e) {
            if (!isDragging) return;
            const pct = getPct(e);
            updateProgress(pct);
            if (videoEl.duration) timeCur.innerText = fmtTime(pct * videoEl.duration);
        }
        function handleDragEnd(e) {
            if (!isDragging) return;
            isDragging = false;
            const pct = getPct(e);
            if (videoEl.duration) {
                videoEl.currentTime = pct * videoEl.duration;
            }
            if (!wasPaused) {
                videoEl.play().catch(()=>{});
            }
        }
        progressWrap.addEventListener('mousedown', handleDragStart);
        progressWrap.addEventListener('touchstart', handleDragStart, {passive:true});
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('touchmove', handleDragMove, {passive:true});
        document.addEventListener('mouseup', handleDragEnd);
        document.addEventListener('touchend', handleDragEnd);

        // Show/hide overlay on tap/click
        document.getElementById('playerWrapper').addEventListener('click', function(e) {
            if (e.target.closest('.vid-btn, .vid-sm-btn, .vid-progress-wrap, .vid-speed-menu')) return;
            toggleOverlay();
        });

        // Close menus on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.vid-speed-wrap')) {
                document.getElementById('speedMenu').style.display = 'none';
                document.getElementById('qualityMenu').style.display = 'none';
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT') return;
            if (e.key === ' ' || e.key === 'k') { e.preventDefault(); togglePlay(); }
            if (e.key === 'ArrowLeft')  seekBy(-10);
            if (e.key === 'ArrowRight') seekBy(10);
            if (e.key === 'f') toggleFS();
            if (e.key === 'Escape') document.body.classList.remove('cinema-mode');
        });
    });

    // ===== OVERLAY =====
    function showOverlay() {
        overlay.classList.add('show');
        clearTimeout(overlayTimer);
        overlayTimer = setTimeout(() => overlay.classList.remove('show'), 3000);
    }
    function toggleOverlay() {
        if (overlay.classList.contains('show')) overlay.classList.remove('show');
        else showOverlay();
    }

    // ===== PLAY =====
    async function playMovie(element, index, scroll = true) {
        currentIndex = index;
        const name = element.dataset.name;

        episodeButtons.forEach(btn => btn.classList.remove('active-episode'));
        element.classList.add('active-episode');
        document.getElementById('currentEpisodeName').innerText = name;
        document.getElementById('vidTitle').innerText = movieName + ' - ' + name;
        saveToWatchHistory(index, name);

        loadingEl.classList.remove('hidden');

        // Ensure links are loaded
        if (!element.dataset.m3u8) {
            if (!prefetchPromise) {
                prefetchPromise = fetch(`https://ophim1.com/phim/${movieSlug}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.episodes) {
                            data.episodes.forEach(server => {
                                server.server_data.forEach(ep => {
                                    episodeButtons.forEach(btn => {
                                        if (btn.dataset.name === ep.name && ep.link_m3u8) {
                                            btn.dataset.m3u8 = ep.link_m3u8;
                                        }
                                    });
                                });
                            });
                        }
                    }).catch(err => console.error("Lỗi lấy link phim:", err));
            }
            await prefetchPromise;
        }

        const m3u8 = element.dataset.m3u8;
        if (!m3u8) {
            loadingEl.classList.add('hidden');
            showToast("Không tìm thấy link video cho tập này", "error");
            return;
        }

        if (Hls.isSupported()) {
            if (hls) hls.destroy();
            hls = new Hls({
                maxBufferLength: 30,
                maxMaxBufferLength: 600,
            });
            hls.loadSource(m3u8);
            hls.attachMedia(videoEl);
            hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                videoEl.play().catch(()=>{});
                renderQualityMenu(data.levels);
            });
            let retryCount = 0;
            hls.on(Hls.Events.ERROR, function(event, data) {
                if (data.fatal) {
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            console.error("fatal network error encountered, try to recover");
                            if (retryCount < 3) {
                                retryCount++;
                                hls.startLoad();
                            } else {
                                hls.destroy();
                                loadingEl.classList.add('hidden');
                                showToast("Không thể tải được video (Lỗi mạng)", "error");
                            }
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            console.error("fatal media error encountered, try to recover");
                            hls.recoverMediaError();
                            break;
                        default:
                            hls.destroy();
                            loadingEl.classList.add('hidden');
                            showToast("Lỗi phát video", "error");
                            break;
                    }
                }
            });
        } else if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
            videoEl.src = m3u8;
            videoEl.play().catch(()=>{});
        }

        if (scroll) {
            window.scrollTo({ top: document.getElementById('playerContainer').offsetTop - 80, behavior: 'smooth' });
        }
        showOverlay();
    }

    // ===== VIDEO CONTROLS =====
    function togglePlay() {
        if (videoEl.paused) videoEl.play().catch(()=>{});
        else videoEl.pause();
        showOverlay();
    }
    function seekBy(sec) {
        videoEl.currentTime = Math.max(0, videoEl.currentTime + sec);
        showOverlay();
    }
    function toggleFS() {
        const wrapper = document.getElementById('playerWrapper');
        if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
            if (wrapper.requestFullscreen) {
                wrapper.requestFullscreen();
            } else if (wrapper.webkitRequestFullscreen) {
                wrapper.webkitRequestFullscreen(); // Safari/iOS
            } else if (wrapper.mozRequestFullScreen) {
                wrapper.mozRequestFullScreen();
            } else if (wrapper.msRequestFullscreen) {
                wrapper.msRequestFullscreen();
            } else if (videoEl.webkitEnterFullscreen) {
                videoEl.webkitEnterFullscreen(); // iOS native video fallback
            }
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
        }
    }
    function togglePIP() {
        if (document.pictureInPictureElement) document.exitPictureInPicture();
        else if (videoEl.requestPictureInPicture) videoEl.requestPictureInPicture();
    }
    function toggleCinemaMode() {
        document.body.classList.toggle('cinema-mode');
    }
    // Volume
    function toggleMute() {
        videoEl.muted = !videoEl.muted;
        document.getElementById('iconVolOn').style.display  = videoEl.muted ? 'none' : '';
        document.getElementById('iconVolOff').style.display = videoEl.muted ? '' : 'none';
    }
    function setVol(v) {
        videoEl.volume = v;
        videoEl.muted = (v == 0);
        document.getElementById('iconVolOn').style.display  = (v == 0) ? 'none' : '';
        document.getElementById('iconVolOff').style.display = (v == 0) ? '' : 'none';
    }
    // Quality
    function toggleQualityMenu() {
        const q = document.getElementById('qualityMenu');
        q.style.display = q.style.display === 'none' ? 'block' : 'none';
        document.getElementById('speedMenu').style.display = 'none'; // hide speed
    }
    function renderQualityMenu(levels) {
        const qList = document.getElementById('qualityList');
        qList.innerHTML = '<button onclick="setQuality(-1, this)" class="active-speed">Auto</button>';
        if (levels && levels.length > 0) {
            let addedQualities = new Set();
            levels.forEach((level, index) => {
                let height = level.height || Math.round(level.bitrate / 1000);
                if (!addedQualities.has(height)) {
                    addedQualities.add(height);
                    let text = level.height ? level.height + 'p' : height + ' kbps';
                    qList.innerHTML += `<button onclick="setQuality(${index}, this)">${text}</button>`;
                }
            });
        }
    }
    function setQuality(levelIndex, btn) {
        if (hls) {
            hls.currentLevel = levelIndex;
            document.getElementById('qualityLabel').innerText = levelIndex === -1 ? 'Auto' : hls.levels[levelIndex].height + 'p';
            document.querySelectorAll('#qualityList button').forEach(b => b.classList.remove('active-speed'));
            if (btn) btn.classList.add('active-speed');
        }
        document.getElementById('qualityMenu').style.display = 'none';
        showOverlay();
    }

    // Speed
    function toggleSpeedMenu() {
        const m = document.getElementById('speedMenu');
        m.style.display = m.style.display === 'none' ? 'block' : 'none';
        document.getElementById('qualityMenu').style.display = 'none'; // hide quality
    }
    function setSpeed(s, btn) {
        videoEl.playbackRate = s;
        document.getElementById('speedLabel').innerText = s === 1 ? '1x' : s + 'x';
        document.getElementById('speedMenu').querySelectorAll('button').forEach(b => b.classList.remove('active-speed'));
        if (btn) btn.classList.add('active-speed');
        document.getElementById('speedMenu').style.display = 'none';
        showOverlay();
    }
    // Icons
    function updatePlayIcon() {
        ['iconPlay','iconPlay2'].forEach(id => document.getElementById(id).style.display   = videoEl.paused ? '' : 'none');
        ['iconPause','iconPause2'].forEach(id => document.getElementById(id).style.display = videoEl.paused ? 'none' : '');
    }
    function updateProgress(pct) {
        const p = (pct * 100).toFixed(2) + '%';
        progressFill.style.width = p;
        progressThumb.style.left = p;
    }
    function onMeta() {
        timeDur.innerText = fmtTime(videoEl.duration);
    }
    function onTimeUpdate() {
        if (!videoEl.duration || isDragging) return;
        timeCur.innerText = fmtTime(videoEl.currentTime);
        updateProgress(videoEl.currentTime / videoEl.duration);
    }
    function fmtTime(s) {
        const m = Math.floor(s / 60), sec = Math.floor(s % 60);
        return m + ':' + String(sec).padStart(2,'0');
    }

    // ===== NAVIGATION =====
    function nextEpisode() {
        if (currentIndex < episodeButtons.length - 1)
            playMovie(episodeButtons[++currentIndex], currentIndex);
    }
    function prevEpisode() {
        if (currentIndex > 0)
            playMovie(episodeButtons[--currentIndex], currentIndex);
    }

    // ===== WATCH HISTORY =====
    function getWatchHistory() {
        try { return JSON.parse(localStorage.getItem('watchHistory')) || []; }
        catch { return []; }
    }
    function saveToWatchHistory(episodeIndex, episodeName) {
        let history = getWatchHistory();
        const idx = history.findIndex(i => i.slug === movieSlug);
        const entry = { slug:movieSlug, name:movieName, poster:moviePoster,
                        episodeIndex, episodeName, year:movieYear,
                        timestamp:Date.now(), progress:5 };
        if (idx !== -1) history[idx] = entry; else history.unshift(entry);
        if (history.length > 20) history = history.slice(0, 20);
        localStorage.setItem('watchHistory', JSON.stringify(history));
    }
    </script>

    <div id="toast" class="toast"></div>

    <script>
    function showToast(message, type = "success") {
        const toast = document.getElementById("toast");

        toast.className = "toast show " + type;
        toast.innerText = message;

        setTimeout(() => {
            toast.className = "toast";
        }, 2500);
    }

    </script>
    @Html.Partial("_Footer")

</body>
</html>

