@{
    Layout = null;
    string statusVN = Model.movie.status switch
    {
        "ongoing" => "ƒêang chi·∫øu",
        "completed" => "Ho√†n th√†nh",
        "trailer" => "Trailer",
        _ => "ƒêang c·∫≠p nh·∫≠t"
    };
}
@model MovieDetailResponse

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@Model.movie.name</title>
    <link rel="stylesheet" href="/css/movie.css" />
    <link rel="stylesheet" href="/css/detail.css" />

</head>
<body data-movie-slug="@ViewBag.MovieId"
      data-movie-name="@Model.movie.name"
      data-movie-poster="@Model.movie.poster_url"
      data-movie-year="@Model.movie.year">

    @Html.Partial("_Header")

    <div class="detail-container">

        <div class="detail-left">
            <img src="@Model.movie.poster_url"
                 onerror="this.src='https://via.placeholder.com/300x450'" />
        </div>

        <div class="detail-right">
            <h1>@Model.movie.name</h1>

            <div class="movie-actions">
                <button id="saveMovieBtn" onclick="toggleSaveMovie()">
                    <span class="icon">‚ô°</span>
                    <span class="text">Th√™m v√†o danh s√°ch</span>
                </button>
            </div>
            <p><strong>T√™n g·ªëc:</strong> @Model.movie.origin_name</p>
            <p><strong>NƒÉm:</strong> @Model.movie.year</p>
            <p>
                <strong>Qu·ªëc gia:</strong>
                @if (Model.movie.country != null && Model.movie.country.Any())
                {
                    @string.Join(", ", Model.movie.country.Select(c => c.name))
                }
                else
                {
                    <span>ƒêang c·∫≠p nh·∫≠t</span>
                }
            </p>
            <p>
                <strong>ƒê·∫°o di·ªÖn:</strong>
                @if (Model.movie.director != null && Model.movie.director.Any())
                {
                    @string.Join(", ", Model.movie.director)
                }
                else
                {
                    <span>ƒêang c·∫≠p nh·∫≠t</span>
                }
            </p>
            <p>
                <strong>Di·ªÖn vi√™n:</strong>
                @if (Model.movie.actor != null && Model.movie.actor.Any())
                {
                    @string.Join(", ", Model.movie.actor)
                }
                else
                {
                    <span>ƒêang c·∫≠p nh·∫≠t</span>
                }
            </p>
            <p><strong>Tr·∫°ng th√°i:</strong> @statusVN</p>

            <div class="movie-description">
                <h3>N·ªôi dung phim</h3>
                <div class="description-content collapsed" id="movieContent">
                    @Html.Raw(Model.movie.content)
                </div>
                <button class="toggle-content" onclick="toggleContent()">Xem th√™m</button>
            </div>
            <script>
            function toggleContent() {
                const content = document.getElementById("movieContent");
                const btn = document.querySelector(".toggle-content");

                content.classList.toggle("collapsed");

                btn.innerText = content.classList.contains("collapsed")
                    ? "Xem th√™m"
                    : "Thu g·ªçn";
            }
            </script>

            <script>
            // ===== MY LIST =====
                function getMyList() {
                    try {
                        return JSON.parse(localStorage.getItem('myList')) || [];
                    } catch {
                        return [];
                    }
                }

                function saveMyList(list) {
                    localStorage.setItem('myList', JSON.stringify(list));
                }

                function toggleSaveMovie() {
                    let list = getMyList();
                    const btn = document.getElementById("saveMovieBtn");

                    const existingIndex = list.findIndex(m => m.slug === movieSlug);

                    if (existingIndex !== -1) {
                        // Remove movie
                        list.splice(existingIndex, 1);
                        btn.classList.remove("saved");
                        btn.innerText = "+ Th√™m v√†o danh s√°ch";
                        showToast("ƒê√£ x√≥a kh·ªèi Danh S√°ch ‚ùå", "remove");
                    } else {
                        // Add movie
                        const movieData = {
                            slug: movieSlug,
                            name: movieName,
                            poster: moviePoster,
                            year: movieYear,
                            savedAt: Date.now()
                        };

                        list.unshift(movieData);

                        if (list.length > 50) {
                            list = list.slice(0, 50);
                        }

                        btn.classList.add("saved");
                        btn.innerText = "‚úì ƒê√£ l∆∞u";
                        showToast("ƒê√£ th√™m v√†o Danh S√°ch ‚ù§Ô∏è", "success");
                    }

                    saveMyList(list);
                }

                // ===== CHECK ON LOAD =====
                function checkIfSaved() {
                    const list = getMyList();
                    const btn = document.getElementById("saveMovieBtn");

                    if (list.some(m => m.slug === movieSlug)) {
                        btn.classList.add("saved");
                        btn.innerText = "‚úì ƒê√£ l∆∞u";
                    }
                }

                document.addEventListener("DOMContentLoaded", function () {
                    checkIfSaved();
                });

            </script>
        </div>

    </div>

    <div class="episode-section">
        <h2>Danh s√°ch t·∫≠p</h2>

        @{
            int index = 0;
        }

        @foreach (var server in Model.episodes)
        {
            <h3>@server.server_name</h3>

            @foreach (var ep in server.server_data)
            {
                <button class="episode-btn"
                        data-index="@index"
                        data-url="@ep.link_embed"
                        data-name="@ep.name"
                        onclick="playMovie(this, @index)">
                    @ep.name
                </button>

                index++;
            }
        }
    </div>

    <div class="now-watching">
        B·∫°n ƒëang xem: T·∫≠p <span id="currentEpisodeName">Ch∆∞a ch·ªçn t·∫≠p</span>
    </div>

    <!-- Player -->
    <div class="player-container">
        <iframe id="moviePlayer"
                width="100%"
                height="600"
                frameborder="0"
                allowfullscreen>
        </iframe>

        <div class="player-controls">
            <button onclick="prevEpisode()">‚èÆ Tr∆∞·ªõc</button>
            <button onclick="toggleCinemaMode()">R·∫°p phim</button>
            <button onclick="nextEpisode()">Sau ‚è≠</button>
        </div>

    </div>

    <!-- Related Movies Section -->
    @if (ViewBag.RelatedMovies != null && ((List<MovieItem>)ViewBag.RelatedMovies).Any())
    {
        <div class="related-movies-section">
            <h2>Phim C√πng Th·ªÉ Lo·∫°i</h2>
            <div class="movie-container">
                @foreach (var item in (List<MovieItem>)ViewBag.RelatedMovies)
                {
                    <div class="movie-card">
                        <a href="/Movie/Detail/@item.slug">
                            <img src="https://img.ophim.live/uploads/movies/@item.poster_url"
                                 alt="@item.name"
                                 onerror="this.src='https://placehold.co/300x450?text=No+Image'" />
                        </a>
                        <div class="movie-info">
                            <h4>@item.name</h4>
                            <p>@item.year</p>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <script>
    // ===== STATE =====
    let currentIndex = 0;
    let episodeButtons = [];
    let iframe = null;

    // Movie metadata from server
    const body = document.body;
    const movieSlug = body.dataset.movieSlug;
    const movieName = body.dataset.movieName;
    const moviePoster = body.dataset.moviePoster;
    const movieYear = parseInt(body.dataset.movieYear) || 0;

    // ===== INIT =====
    document.addEventListener("DOMContentLoaded", function () {
        episodeButtons = document.querySelectorAll(".episode-btn");
        iframe = document.getElementById("moviePlayer");

        const history = getWatchHistory();
        const savedEntry = history.find(item => item.slug === movieSlug);

        if (savedEntry && episodeButtons[savedEntry.episodeIndex]) {
            // N·∫øu ƒë√£ xem tr∆∞·ªõc ƒë√≥ ‚Üí m·ªü l·∫°i t·∫≠p c≈©
            playMovie(episodeButtons[savedEntry.episodeIndex], savedEntry.episodeIndex);
        } 
        else if (episodeButtons.length > 0) {
            // üî• N·∫øu ch∆∞a c√≥ history ‚Üí t·ª± ƒë·ªông ch·ªçn t·∫≠p 1
            playMovie(episodeButtons[0], 0);
        }

        startProgressTracker();
    });

    // ===== CINEMAMODE =====
    function toggleCinemaMode() {
        document.body.classList.toggle("cinema-mode");
    }

    document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
            document.body.classList.remove("cinema-mode");
        }
    });

    // ===== PLAY =====
    function playMovie(element, index) {
        currentIndex = index;

        const url = element.dataset.url;
        const name = element.dataset.name;

        iframe.src = url;

        // Highlight active episode
        episodeButtons.forEach(btn => btn.classList.remove("active-episode"));
        element.classList.add("active-episode");

        document.getElementById("currentEpisodeName").innerText = name;

        // Save to watch history
        saveToWatchHistory(index, name);

        // Also keep backward-compatible old key
        localStorage.setItem("currentEpisode_" + movieSlug, index);

        window.scrollTo({
            top: iframe.offsetTop - 100,
            behavior: "smooth"
        });
    }

    // ===== WATCH HISTORY MANAGEMENT =====
    function getWatchHistory() {
        try {
            return JSON.parse(localStorage.getItem('watchHistory')) || [];
        } catch (e) {
            return [];
        }
    }

    function saveToWatchHistory(episodeIndex, episodeName) {
        let history = getWatchHistory();

        // Check if this movie already exists in history
        const existingIdx = history.findIndex(item => item.slug === movieSlug);

        const entry = {
            slug: movieSlug,
            name: movieName,
            poster: moviePoster,
            episodeIndex: episodeIndex,
            episodeName: episodeName,
            year: movieYear,
            timestamp: Date.now(),
            progress: 5 // Start at 5% when just started watching
        };

        if (existingIdx !== -1) {
            // Update existing entry
            history[existingIdx] = entry;
        } else {
            // Add new entry at beginning
            history.unshift(entry);
        }

        // Limit to 20 items max
        if (history.length > 20) {
            history = history.slice(0, 20);
        }

        localStorage.setItem('watchHistory', JSON.stringify(history));
    }

    // Simulate watching progress ‚Äî update every 2 minutes
    function startProgressTracker() {
        setInterval(function () {
            if (!iframe.src || iframe.src === 'about:blank') return;

            let history = getWatchHistory();
            const idx = history.findIndex(item => item.slug === movieSlug);
            if (idx !== -1) {
                // Increment progress by a small amount (simulating watching)
                let currentProgress = history[idx].progress || 5;
                if (currentProgress < 90) {
                    history[idx].progress = Math.min(90, currentProgress + 8);
                    history[idx].timestamp = Date.now();
                    localStorage.setItem('watchHistory', JSON.stringify(history));
                }
            }
        }, 120000); // Every 2 minutes
    }

    // ===== NAVIGATION =====
    function nextEpisode() {
        if (currentIndex < episodeButtons.length - 1) {
            currentIndex++;
            playMovie(episodeButtons[currentIndex], currentIndex);
        }
    }

    function prevEpisode() {
        if (currentIndex > 0) {
            currentIndex--;
            playMovie(episodeButtons[currentIndex], currentIndex);
        }
    }

    

</script>

    <div id="toast" class="toast"></div>

    <script>
    function showToast(message, type = "success") {
        const toast = document.getElementById("toast");

        toast.className = "toast show " + type;
        toast.innerText = message;

        setTimeout(() => {
            toast.className = "toast";
        }, 2500);
    }

    </script>
    @Html.Partial("_Footer")

</body>
</html>

