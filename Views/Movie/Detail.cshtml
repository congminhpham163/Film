@{
    Layout = null;
    int index = 0;
}
@model MovieDetailResponse

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>@Model.movie.name</title>
    <link rel="stylesheet" href="/css/movie.css" />
    <link rel="stylesheet" href="/css/detail.css" />

</head>
<body>

    @Html.Partial("_Header")

    <div class="detail-container">

        <div class="detail-left">
            <img src="@Model.movie.poster_url"
                 onerror="this.src='https://via.placeholder.com/300x450'" />
        </div>

        <div class="detail-right">
            <h1>@Model.movie.name</h1>
            <p><strong>T√™n g·ªëc:</strong> @Model.movie.origin_name</p>
            <p><strong>NƒÉm:</strong> @Model.movie.year</p>
            <p>
                <strong>Qu·ªëc gia:</strong>
                @if (Model.movie.country != null && Model.movie.country.Any())
                {
                    @string.Join(", ", Model.movie.country.Select(c => c.name))
                }
                else
                {
                    <span>ƒêang c·∫≠p nh·∫≠t</span>
                }
            </p>
            <p><strong>Tr·∫°ng th√°i:</strong> @Model.movie.status</p>
            <p>@Html.Raw(Model.movie.content)</p>
        </div>

    </div>

    <div class="episode-section">
        <h2>Danh s√°ch t·∫≠p</h2>

        @{
            int index = 0;
        }

        @foreach (var server in Model.episodes)
        {
            <h3>@server.server_name</h3>

            @foreach (var ep in server.server_data)
            {
                <button class="episode-btn"
                        data-index="@index"
                        data-url="@ep.link_embed"
                        data-name="@ep.name"
                        onclick="playMovie(this, @index)">
                    @ep.name
                </button>

                index++;
            }
        }
    </div>

    <div class="now-watching">
        B·∫°n ƒëang xem: T·∫≠p <span id="currentEpisodeName">Ch∆∞a ch·ªçn t·∫≠p</span>
    </div>

    <!-- Player -->
    <div class="player-container">
        <iframe id="moviePlayer"
                width="100%"
                height="600"
                frameborder="0"
                allowfullscreen>
        </iframe>
        
        <div class="player-controls">
            <button onclick="prevEpisode()">‚èÆ Previous</button>
            <button onclick="nextEpisode()">Next ‚è≠</button>
        </div>

    </div>

    <!-- Related Movies Section -->
    @if (ViewBag.RelatedMovies != null && ((List<MovieItem>)ViewBag.RelatedMovies).Any())
    {
        <div class="related-movies-section">
            <h2>Phim C√πng Th·ªÉ Lo·∫°i</h2>
            <div class="movie-container">
                @foreach (var item in (List<MovieItem>)ViewBag.RelatedMovies)
                {
                    <div class="movie-card">
                        <a href="/Movie/Detail/@item.slug">
                            <img src="https://img.ophim.live/uploads/movies/@item.poster_url"
                                 alt="@item.name"
                                 onerror="this.src='https://via.placeholder.com/300x450'" />
                        </a>
                        <div class="movie-info">
                            <h4>@item.name</h4>
                            <p>@item.year</p>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <script>
    let currentIndex = 0;
    let episodeButtons = [];
    let iframe = null;
    const movieId = "@ViewBag.MovieId";

    document.addEventListener("DOMContentLoaded", function () {

        episodeButtons = document.querySelectorAll(".episode-btn");
        iframe = document.getElementById("moviePlayer");

        const savedIndex = localStorage.getItem("currentEpisode_" + movieId);

        if (savedIndex !== null && episodeButtons[savedIndex]) {
            playMovie(episodeButtons[savedIndex], parseInt(savedIndex));
        }
    });

    function playMovie(element, index) {

        currentIndex = index;

        const url = element.dataset.url;
        const name = element.dataset.name;

        iframe.src = url;

        // L∆∞u theo t·ª´ng phim
        localStorage.setItem("currentEpisode_" + movieId, index);

        episodeButtons.forEach(btn => btn.classList.remove("active-episode"));
        element.classList.add("active-episode");

        document.getElementById("currentEpisodeName").innerText = name;

        autoNextAfterTime();

        window.scrollTo({
            top: iframe.offsetTop - 100,
            behavior: "smooth"
        });
    }


    function nextEpisode() {
        if (currentIndex < episodeButtons.length - 1) {
            currentIndex++;
            playMovie(episodeButtons[currentIndex], currentIndex);
        }
    }

    function prevEpisode() {
        if (currentIndex > 0) {
            currentIndex--;
            playMovie(episodeButtons[currentIndex], currentIndex);
        }
    }

    // üî• Auto next (v√¨ iframe embed kh√¥ng b·∫Øt ƒë∆∞·ª£c s·ª± ki·ªán ended)
    function autoNextAfterTime() {

        // Clear timer c≈©
        if (window.autoNextTimer) {
            clearTimeout(window.autoNextTimer);
        }

        // Gi·∫£ s·ª≠ 45 ph√∫t = 2700000 ms
        window.autoNextTimer = setTimeout(() => {
            nextEpisode();
        }, 2700000);
    }

</script>



    @Html.Partial("_Footer")

</body>
</html>
