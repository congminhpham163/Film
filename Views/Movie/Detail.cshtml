@{
    Layout = null;
}
@model MovieDetailResponse

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@Model.movie.name</title>
    <link rel="stylesheet" href="/css/movie.css" />
    <link rel="stylesheet" href="/css/detail.css" />

</head>
<body data-movie-slug="@ViewBag.MovieId"
      data-movie-name="@Model.movie.name"
      data-movie-poster="@Model.movie.poster_url"
      data-movie-year="@Model.movie.year">

    @Html.Partial("_Header")

    <div class="detail-container">

        <div class="detail-left">
            <img src="@Model.movie.poster_url"
                 onerror="this.src='https://via.placeholder.com/300x450'" />
        </div>

        <div class="detail-right">
            <h1>@Model.movie.name</h1>
            <p><strong>T√™n g·ªëc:</strong> @Model.movie.origin_name</p>
            <p><strong>NƒÉm:</strong> @Model.movie.year</p>
            <p>
                <strong>Qu·ªëc gia:</strong>
                @if (Model.movie.country != null && Model.movie.country.Any())
                {
                    @string.Join(", ", Model.movie.country.Select(c => c.name))
                }
                else
                {
                    <span>ƒêang c·∫≠p nh·∫≠t</span>
                }
            </p>
            <p><strong>Tr·∫°ng th√°i:</strong> @Model.movie.status</p>
            <p>@Html.Raw(Model.movie.content)</p>
        </div>

    </div>

    <div class="episode-section">
        <h2>Danh s√°ch t·∫≠p</h2>

        @{
            int index = 0;
        }

        @foreach (var server in Model.episodes)
        {
            <h3>@server.server_name</h3>

            @foreach (var ep in server.server_data)
            {
                <button class="episode-btn"
                        data-index="@index"
                        data-url="@ep.link_embed"
                        data-name="@ep.name"
                        onclick="playMovie(this, @index)">
                    @ep.name
                </button>

                index++;
            }
        }
    </div>

    <div class="now-watching">
        B·∫°n ƒëang xem: T·∫≠p <span id="currentEpisodeName">Ch∆∞a ch·ªçn t·∫≠p</span>
    </div>

    <!-- Player -->
    <div class="player-container">
        <iframe id="moviePlayer"
                width="100%"
                height="600"
                frameborder="0"
                allowfullscreen>
        </iframe>
        
        <div class="player-controls">
            <button onclick="prevEpisode()">‚èÆ Previous</button>
            <button onclick="nextEpisode()">Next ‚è≠</button>
        </div>

    </div>

    <!-- Related Movies Section -->
    @if (ViewBag.RelatedMovies != null && ((List<MovieItem>)ViewBag.RelatedMovies).Any())
    {
        <div class="related-movies-section">
            <h2>Phim C√πng Th·ªÉ Lo·∫°i</h2>
            <div class="movie-container">
                @foreach (var item in (List<MovieItem>)ViewBag.RelatedMovies)
                {
                    <div class="movie-card">
                        <a href="/Movie/Detail/@item.slug">
                            <img src="https://img.ophim.live/uploads/movies/@item.poster_url"
                                 alt="@item.name"
                                 onerror="this.src='https://via.placeholder.com/300x450'" />
                        </a>
                        <div class="movie-info">
                            <h4>@item.name</h4>
                            <p>@item.year</p>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <script>
    // ===== STATE =====
    let currentIndex = 0;
    let episodeButtons = [];
    let iframe = null;

    // Movie metadata from server
    const body = document.body;
    const movieSlug = body.dataset.movieSlug;
    const movieName = body.dataset.movieName;
    const moviePoster = body.dataset.moviePoster;
    const movieYear = parseInt(body.dataset.movieYear) || 0;

    // ===== INIT =====
    document.addEventListener("DOMContentLoaded", function () {
        episodeButtons = document.querySelectorAll(".episode-btn");
        iframe = document.getElementById("moviePlayer");

        // Try to restore from watchHistory first, fallback to old key
        const history = getWatchHistory();
        const savedEntry = history.find(item => item.slug === movieSlug);

        if (savedEntry && episodeButtons[savedEntry.episodeIndex]) {
            playMovie(episodeButtons[savedEntry.episodeIndex], savedEntry.episodeIndex);
        } else {
            // Fallback: check old per-movie key
            const oldSaved = localStorage.getItem("currentEpisode_" + movieSlug);
            if (oldSaved !== null && episodeButtons[parseInt(oldSaved)]) {
                playMovie(episodeButtons[parseInt(oldSaved)], parseInt(oldSaved));
            }
        }

        // Periodically update progress (simulate watching progress)
        startProgressTracker();
    });

    // ===== PLAY =====
    function playMovie(element, index) {
        currentIndex = index;

        const url = element.dataset.url;
        const name = element.dataset.name;

        iframe.src = url;

        // Highlight active episode
        episodeButtons.forEach(btn => btn.classList.remove("active-episode"));
        element.classList.add("active-episode");

        document.getElementById("currentEpisodeName").innerText = name;

        // Save to watch history
        saveToWatchHistory(index, name);

        // Also keep backward-compatible old key
        localStorage.setItem("currentEpisode_" + movieSlug, index);

        autoNextAfterTime();

        window.scrollTo({
            top: iframe.offsetTop - 100,
            behavior: "smooth"
        });
    }

    // ===== WATCH HISTORY MANAGEMENT =====
    function getWatchHistory() {
        try {
            return JSON.parse(localStorage.getItem('watchHistory')) || [];
        } catch (e) {
            return [];
        }
    }

    function saveToWatchHistory(episodeIndex, episodeName) {
        let history = getWatchHistory();

        // Check if this movie already exists in history
        const existingIdx = history.findIndex(item => item.slug === movieSlug);

        const entry = {
            slug: movieSlug,
            name: movieName,
            poster: moviePoster,
            episodeIndex: episodeIndex,
            episodeName: episodeName,
            year: movieYear,
            timestamp: Date.now(),
            progress: 5 // Start at 5% when just started watching
        };

        if (existingIdx !== -1) {
            // Update existing entry
            history[existingIdx] = entry;
        } else {
            // Add new entry at beginning
            history.unshift(entry);
        }

        // Limit to 20 items max
        if (history.length > 20) {
            history = history.slice(0, 20);
        }

        localStorage.setItem('watchHistory', JSON.stringify(history));
    }

    // Simulate watching progress ‚Äî update every 2 minutes
    function startProgressTracker() {
        setInterval(function () {
            if (!iframe.src || iframe.src === 'about:blank') return;

            let history = getWatchHistory();
            const idx = history.findIndex(item => item.slug === movieSlug);
            if (idx !== -1) {
                // Increment progress by a small amount (simulating watching)
                let currentProgress = history[idx].progress || 5;
                if (currentProgress < 90) {
                    history[idx].progress = Math.min(90, currentProgress + 8);
                    history[idx].timestamp = Date.now();
                    localStorage.setItem('watchHistory', JSON.stringify(history));
                }
            }
        }, 120000); // Every 2 minutes
    }

    // ===== NAVIGATION =====
    function nextEpisode() {
        if (currentIndex < episodeButtons.length - 1) {
            currentIndex++;
            playMovie(episodeButtons[currentIndex], currentIndex);
        }
    }

    function prevEpisode() {
        if (currentIndex > 0) {
            currentIndex--;
            playMovie(episodeButtons[currentIndex], currentIndex);
        }
    }

    // üî• Auto next (v√¨ iframe embed kh√¥ng b·∫Øt ƒë∆∞·ª£c s·ª± ki·ªán ended)
    function autoNextAfterTime() {
        // Clear timer c≈©
        if (window.autoNextTimer) {
            clearTimeout(window.autoNextTimer);
        }

        // Gi·∫£ s·ª≠ 45 ph√∫t = 2700000 ms
        window.autoNextTimer = setTimeout(() => {
            nextEpisode();
        }, 2700000);
    }

</script>



    @Html.Partial("_Footer")

</body>
</html>

