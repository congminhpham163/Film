@{
    Layout = null;
    int current = ViewBag.CurrentPage ?? 1;
    int total = ViewBag.TotalPages ?? 1;

    int start = Math.Max(1, current - 2);
    int end = Math.Min(total, current + 2);
}
@model List<MovieItem>

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Movie+</title>
    <link rel="stylesheet" href="/css/movie.css" />
    <link rel="stylesheet" href="/css/continue-watching.css" />
</head>
<body>

    @Html.Partial("_Header")

    <!-- LUNAR NEW YEAR BANNER -->
    <div class="tet-banner">
        <div class="tet-overlay"></div>

        <div class="tet-content">
            <h1>üßß Ch√∫c M·ª´ng NƒÉm M·ªõi √Çm L·ªãch 2026 üßß</h1>
            <p>An khang th·ªãnh v∆∞·ª£ng ‚Äì V·∫°n s·ª± nh∆∞ √Ω ‚Äì Xem phim th·∫£ ga c√πng Movie+ üçø</p>
        </div>

        <div class="lantern lantern-left"></div>
        <div class="lantern lantern-right"></div>
    </div>
    <script>
    function createPetal() {
        const petal = document.createElement("div");

        const symbols = ["üå∏", "üßß", "‚ú®", "üèµÔ∏è"];
        petal.innerHTML = symbols[Math.floor(Math.random() * symbols.length)];

        petal.className = "petal";
        petal.style.left = Math.random() * 100 + "vw";
        petal.style.animationDuration = (3 + Math.random() * 5) + "s";

        document.body.appendChild(petal);

        setTimeout(() => petal.remove(), 8000);
    }

    setInterval(createPetal, 400);
    </script>

    <!-- Continue Watching Section -->
    <div class="continue-watching-section" id="continueWatchingSection">
        <h2>ƒêang xem</h2>
        <div class="cw-scroll" id="cwScroll">
            <!-- JS will render cards here -->
        </div>
    </div>

    <!-- My List Section -->
    <div class="continue-watching-section" id="myListSection">
        <h2>Danh s√°ch xem sau</h2>
        <div class="cw-scroll" id="myListScroll">
            <!-- JS render here -->
        </div>
    </div>
    

    <form method="get" action="/Movie" class="filter-form">

        <select name="category">
            <option value="">-- Th·ªÉ lo·∫°i --</option>
            <option value="hoathinh" selected="@(ViewBag.Category == "hoathinh")">Ho·∫°t H√¨nh</option>
            @foreach (var item in (List<CategoryItem>)ViewBag.Categories)
            {
                <option value="@item.slug" selected="@(ViewBag.Category == item.slug)">@item.name</option>
            }
        </select>

        <select name="country">
            <option value="">-- Qu·ªëc gia --</option>
            @foreach (var item in (List<CategoryItem>)ViewBag.Countries)
            {
                <option value="@item.slug" selected="@(ViewBag.Country == item.slug)">@item.name</option>
            }
        </select>

        <select name="year">
            <option value="">-- NƒÉm --</option>
            @foreach (var y in (List<int>)ViewBag.Years)
            {
                <option value="@y" selected="@(ViewBag.Year == y.ToString())">@y</option>
            }
        </select>

        <select name="type">
            <option value="">-- ƒê·ªãnh d·∫°ng --</option>
            <option value="single" selected="@(ViewBag.Type == "single")">Phim l·∫ª</option>
            <option value="series" selected="@(ViewBag.Type == "series")">Phim b·ªô</option>
            <option value="hoathinh" selected="@(ViewBag.Type == "hoathinh")">Ho·∫°t h√¨nh</option>
        </select>

        <select name="quality">
            <option value="">-- Ch·∫•t l∆∞·ª£ng --</option>
            <option value="FHD" selected="@(ViewBag.Quality == "FHD")">Full HD (FHD)</option>
            <option value="HD" selected="@(ViewBag.Quality == "HD")">HD</option>
            <option value="SD" selected="@(ViewBag.Quality == "SD")">SD</option>
        </select>

        <select name="lang">
            <option value="">-- Ng√¥n ng·ªØ --</option>
            <option value="Vietsub" selected="@(ViewBag.Lang == "Vietsub")">Vietsub</option>
            <option value="Thuy·∫øt Minh" selected="@(ViewBag.Lang == "Thuy·∫øt Minh")">Thuy·∫øt Minh</option>
            <option value="L·ªìng Ti·∫øng" selected="@(ViewBag.Lang == "L·ªìng Ti·∫øng")">L·ªìng Ti·∫øng</option>
        </select>

        <button type="submit">L·ªçc</button>
    </form>


    @if(ViewBag.IsHomePage != null && (bool)ViewBag.IsHomePage == true)
    {
        <!-- TRANG CH·ª¶ (HOME PAGE) -->
        <h2 class="row-header">
            Phim M·ªõi C·∫≠p Nh·∫≠t
        </h2>
        <div class="movie-row-container">
            <div class="movie-row">
                @if(ViewBag.LatestMovies != null)
                {
                    foreach (var movie in (List<MovieItem>)ViewBag.LatestMovies)
                    {
                        <div class="movie-card">
                            <button class="favorite-btn"
                                    data-slug="@movie.slug"
                                    data-name="@movie.name"
                                    data-poster="https://img.ophim.live/uploads/movies/@movie.poster_url"
                                    data-year="@movie.year"
                                    onclick="toggleFavorite(event, this)">
                                +
                            </button>
                            <a href="/Movie/Detail/@movie.slug">
                                <img src="https://img.ophim.live/uploads/movies/@movie.poster_url"
                                     onerror="this.src='https://placehold.co/300x450?text=No+Image'" />
                            </a>

                            <div class="movie-info">
                                <h4>@movie.name</h4>
                                <p>@movie.year</p>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>

        <h2 class="row-header">
            Phim H√†nh ƒê·ªông 
            <a href="/Movie?category=hanh-dong" class="view-all-link">Xem T·∫•t C·∫£ ¬ª</a>
        </h2>
        <div class="movie-row-container">
            <div class="movie-row">
                @if(ViewBag.ActionMovies != null)
                {
                    foreach (var movie in (List<MovieItem>)ViewBag.ActionMovies)
                    {
                        <div class="movie-card">
                            <button class="favorite-btn"
                                    data-slug="@movie.slug"
                                    data-name="@movie.name"
                                    data-poster="https://img.ophim.live/uploads/movies/@movie.poster_url"
                                    data-year="@movie.year"
                                    onclick="toggleFavorite(event, this)">
                                +
                            </button>
                            <a href="/Movie/Detail/@movie.slug">
                                <img src="https://img.ophim.live/uploads/movies/@movie.poster_url"
                                     onerror="this.src='https://placehold.co/300x450?text=No+Image'" />
                            </a>
                            <div class="movie-info">
                                <h4>@movie.name</h4>
                                <p>@movie.year</p>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>

        <h2 class="row-header">
            Phim Kinh D·ªã 
            <a href="/Movie?category=kinh-di" class="view-all-link">Xem T·∫•t C·∫£ ¬ª</a>
        </h2>
        <div class="movie-row-container">
            <div class="movie-row">
                @if(ViewBag.HorrorMovies != null)
                {
                    foreach (var movie in (List<MovieItem>)ViewBag.HorrorMovies)
                    {
                        <div class="movie-card">
                            <button class="favorite-btn"
                                    data-slug="@movie.slug"
                                    data-name="@movie.name"
                                    data-poster="https://img.ophim.live/uploads/movies/@movie.poster_url"
                                    data-year="@movie.year"
                                    onclick="toggleFavorite(event, this)">
                                +
                            </button>
                            <a href="/Movie/Detail/@movie.slug">
                                <img src="https://img.ophim.live/uploads/movies/@movie.poster_url"
                                     onerror="this.src='https://placehold.co/300x450?text=No+Image'" />
                            </a>
                            <div class="movie-info">
                                <h4>@movie.name</h4>
                                <p>@movie.year</p>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>

        <h2 class="row-header">
            Phim Ho·∫°t H√¨nh 
            <a href="/Movie?category=hoathinh" class="view-all-link">Xem T·∫•t C·∫£ ¬ª</a>
        </h2>
        <div class="movie-row-container">
            <div class="movie-row">
                @if(ViewBag.AnimationMovies != null)
                {
                    foreach (var movie in (List<MovieItem>)ViewBag.AnimationMovies)
                    {
                        <div class="movie-card">
                            <button class="favorite-btn"
                                    data-slug="@movie.slug"
                                    data-name="@movie.name"
                                    data-poster="https://img.ophim.live/uploads/movies/@movie.poster_url"
                                    data-year="@movie.year"
                                    onclick="toggleFavorite(event, this)">
                                +
                            </button>
                            <a href="/Movie/Detail/@movie.slug">
                                <img src="https://img.ophim.live/uploads/movies/@movie.poster_url"
                                     onerror="this.src='https://placehold.co/300x450?text=No+Image'" />
                            </a>

                            <div class="movie-info">
                                <h4>@movie.name</h4>
                                <p>@movie.year</p>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    }
    else
    {
        <!-- TRANG DANH S√ÅCH (LIST PAGE) -->
        <h2>
            @if(ViewBag.Keyword != null)
            {
                <text>K·∫øt qu·∫£ t√¨m ki·∫øm: "@ViewBag.Keyword"</text>
            }
            else
            {
                <text>Danh s√°ch phim</text>
            }
        </h2>


        <div class="movie-container">
            @foreach (var movie in Model)
            {
                <div class="movie-card">
                    <button class="favorite-btn"
                            data-slug="@movie.slug"
                            data-name="@movie.name"
                            data-poster="https://img.ophim.live/uploads/movies/@movie.poster_url"
                            data-year="@movie.year"
                            onclick="toggleFavorite(event, this)">
                        +
                    </button>
                    <a href="/Movie/Detail/@movie.slug">
                        <img src="https://img.ophim.live/uploads/movies/@movie.poster_url"
                             onerror="this.src='https://placehold.co/300x450?text=No+Image'" />
                    </a>

                    <div class="movie-info">
                        <h4>@movie.name</h4>
                        <p>@movie.year</p>
                    </div>
                </div>
            }
        </div>

        <div class="pagination">
            @if (current > 1)
            {
                <a class="page-nav"
                asp-controller="Movie"
                asp-action="Index"
                asp-route-page="@(current - 1)"
                asp-route-category="@ViewBag.Category"
                asp-route-country="@ViewBag.Country"
                asp-route-year="@ViewBag.Year">
                ¬´ Tr∆∞·ªõc
                </a>
            }

            <!-- Trang 1 -->
            @if (start > 1)
            {
                <a class="page-number"
                asp-controller="Movie"
                asp-action="Index"
                asp-route-page="1"
                asp-route-category="@ViewBag.Category"
                asp-route-country="@ViewBag.Country"
                asp-route-year="@ViewBag.Year"
                asp-route-keyword="@ViewBag.Keyword">
                    1
                </a>


                @if (start > 2)
                {
                    <span class="page-dots">...</span>
                }
            }

            <!-- C√°c trang gi·ªØa -->
            @for (int i = start; i <= end; i++)
            {
                if (i == current)
                {
                    <span class="page-number active">@i</span>
                }
                else
                {
                    <a class="page-number"
                    asp-controller="Movie"
                    asp-action="Index"
                    asp-route-page="@i"
                    asp-route-category="@ViewBag.Category"
                    asp-route-country="@ViewBag.Country"
                    asp-route-year="@ViewBag.Year"
                    asp-route-keyword="@ViewBag.Keyword">
                    @i
                    </a>
                }
            }

            <!-- Trang cu·ªëi -->
            @if (end < total)
            {
                @if (end < total - 1)
                {
                    <span class="page-dots">...</span>
                }

                <a class="page-number"
                asp-controller="Movie"
                asp-action="Index"
                asp-route-page="@total"
                asp-route-category="@ViewBag.Category"
                asp-route-country="@ViewBag.Country"
                asp-route-year="@ViewBag.Year"
                asp-route-keyword="@ViewBag.Keyword">
                @total
                </a>

            }

            @if (current < total)
            {
                <a class="page-nav"
                asp-controller="Movie"
                asp-action="Index"
                asp-route-page="@(current + 1)"
                asp-route-category="@ViewBag.Category"
                asp-route-country="@ViewBag.Country"
                asp-route-year="@ViewBag.Year"
                asp-route-keyword="@ViewBag.Keyword">
                Sau ¬ª
                </a>
            }

        </div>
    }


    @Html.Partial("_Footer")

    <script>
        // ===== CONTINUE WATCHING ‚Äî Render from localStorage =====
        document.addEventListener('DOMContentLoaded', function () {
            renderContinueWatching();
        });

        function renderContinueWatching() {
            const section = document.getElementById('continueWatchingSection');
            const scroll = document.getElementById('cwScroll');
            const history = getWatchHistory();

            if (!history || history.length === 0) {
                section.classList.remove('has-items');
                return;
            }

            section.classList.add('has-items');
            scroll.innerHTML = '';

            // Sort by most recently watched
            history.sort((a, b) => b.timestamp - a.timestamp);

            history.forEach(function (item, idx) {
                const card = document.createElement('a');
                card.href = '/Movie/Detail/' + item.slug;
                card.className = 'cw-card';

                // Fake progress bar (random between 15% and 85% to look realistic)
                const progress = item.progress || Math.floor(Math.random() * 70 + 15);

                card.innerHTML =
                    '<div class="cw-thumb">' +
                        '<img src="' + item.poster + '" onerror="this.src=\'https://placehold.co/400x225?text=No+Image\'" alt="' + escapeHtml(item.name) + '" />' +
                        '<div class="cw-play-overlay"></div>' +
                        '<span class="cw-episode-badge">T·∫≠p ' + escapeHtml(item.episodeName) + '</span>' +
                        '<div class="cw-progress"><div class="cw-progress-bar" style="width: ' + progress + '%"></div></div>' +
                    '</div>' +
                    '<div class="cw-info">' +
                        '<h4>' + escapeHtml(item.name) + '</h4>' +
                        '<p>' + (item.year || '') + '</p>' +
                        '<div class="cw-time">' + timeAgo(item.timestamp) + '</div>' +
                    '</div>' +
                    '<button class="cw-remove" data-slug="' + item.slug + '" title="X√≥a kh·ªèi l·ªãch s·ª≠" onclick="removeCWItem(event, \'' + item.slug + '\')">‚úï</button>';

                scroll.appendChild(card);
            });
        }

        function getWatchHistory() {
            try {
                return JSON.parse(localStorage.getItem('watchHistory')) || [];
            } catch (e) {
                return [];
            }
        }

        function removeCWItem(e, slug) {
            e.preventDefault();
            e.stopPropagation();
            let history = getWatchHistory();
            history = history.filter(item => item.slug !== slug);
            localStorage.setItem('watchHistory', JSON.stringify(history));
            renderContinueWatching();
        }

        function timeAgo(ts) {
            const diff = Date.now() - ts;
            const mins = Math.floor(diff / 60000);
            if (mins < 1) return 'V·ª´a xong';
            if (mins < 60) return mins + ' ph√∫t tr∆∞·ªõc';
            const hours = Math.floor(mins / 60);
            if (hours < 24) return hours + ' gi·ªù tr∆∞·ªõc';
            const days = Math.floor(hours / 24);
            if (days < 7) return days + ' ng√†y tr∆∞·ªõc';
            return Math.floor(days / 7) + ' tu·∫ßn tr∆∞·ªõc';
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // ===== MY LIST RENDER =====
        document.addEventListener('DOMContentLoaded', function () {
            renderMyList();
        });

        function getMyList() {
            try {
                return JSON.parse(localStorage.getItem('myList')) || [];
            } catch (e) {
                return [];
            }
        }

        function renderMyList() {
    const section = document.getElementById('myListSection');
    const scroll = document.getElementById('myListScroll');
    const list = getMyList();

    if (!list || list.length === 0) {
        section.classList.remove('has-items');
        return;
    }

    section.classList.add('has-items');
    scroll.innerHTML = '';

    // üî• NOTE: S·∫Øp x·∫øp phim m·ªõi l∆∞u l√™n tr∆∞·ªõc
    list.sort((a, b) => b.savedAt - a.savedAt);

    const MAX_VISIBLE = 10; // üî• NOTE: S·ªë phim hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh
    const isExpanded = scroll.classList.contains("expanded");

    // üî• NOTE: N·∫øu ch∆∞a m·ªü r·ªông v√† list > 10 ‚Üí ch·ªâ hi·ªÉn th·ªã 10 phim ƒë·∫ßu
    const moviesToRender = (!isExpanded && list.length > MAX_VISIBLE)
        ? list.slice(0, MAX_VISIBLE)
        : list;

    moviesToRender.forEach(function (item) {
        const card = document.createElement('a');
        card.href = '/Movie/Detail/' + item.slug;
        card.className = 'cw-card';

        card.innerHTML =
            '<div class="cw-thumb">' +
                '<img src="' + item.poster + '" onerror="this.src=\'https://placehold.co/400x225?text=No+Image\'" alt="' + escapeHtml(item.name) + '" />' +
                '<div class="cw-play-overlay"></div>' +
            '</div>' +
            '<div class="cw-info">' +
                '<h4>' + escapeHtml(item.name) + '</h4>' +
                '<p>' + (item.year || '') + '</p>' +
                '<div class="cw-time">ƒê√£ l∆∞u</div>' +
            '</div>' +
            '<button class="cw-remove" onclick="removeMyListItem(event, \'' + item.slug + '\')">‚úï</button>';

        scroll.appendChild(card);
    });

    // üî• NOTE: N·∫øu list > 10 v√† ch∆∞a expand ‚Üí th√™m n√∫t Xem Th√™m
    if (!isExpanded && list.length > MAX_VISIBLE) {
        const moreBtn = document.createElement('div');
        moreBtn.className = 'cw-card more-card';

        moreBtn.innerHTML = `
            <div class="more-circle">+</div>
            <p>Xem th√™m</p>
        `;

        moreBtn.onclick = function () {
            window.location.href = "/Movie/MyList";
        };

        scroll.appendChild(moreBtn);
    }

}


        function removeMyListItem(e, slug) {
            e.preventDefault();
            e.stopPropagation();

            let list = getMyList();
            list = list.filter(item => item.slug !== slug);

            localStorage.setItem('myList', JSON.stringify(list));

            renderMyList();
            updateFavoriteButtons();
            showToast("ƒê√£ x√≥a kh·ªèi Danh S√°ch ‚ùå", "remove");
        }

        // ===== FAVORITE BUTTON ON MOVIE CARD =====

        function toggleFavorite(e, btn) {
            e.preventDefault();
            e.stopPropagation();

            const slug = btn.dataset.slug;
            const name = btn.dataset.name;
            const poster = btn.dataset.poster;
            const year = btn.dataset.year;

            let list = getMyList();
            const existingIndex = list.findIndex(m => m.slug === slug);

            if (existingIndex !== -1) {
                // REMOVE
                list.splice(existingIndex, 1);
                btn.classList.remove("saved");
                btn.innerText = "+";
                showToast("ƒê√£ x√≥a kh·ªèi Danh S√°ch ‚ùå", "remove");
            } else {
                // ADD
                list.unshift({
                    slug: slug,
                    name: name,
                    poster: poster,
                    year: year,
                    savedAt: Date.now()
                });

                btn.classList.add("saved");
                btn.innerText = "‚úì";
                showToast("ƒê√£ th√™m v√†o Danh S√°ch ‚ù§Ô∏è", "success");
            }

            localStorage.setItem('myList', JSON.stringify(list));

            // üî• QUAN TR·ªåNG: c·∫≠p nh·∫≠t l·∫°i section ngay l·∫≠p t·ª©c
            renderMyList();
        }


        // ===== CHECK FAVORITE STATE ON LOAD =====
        document.addEventListener("DOMContentLoaded", function () {
            const list = getMyList();
            const buttons = document.querySelectorAll(".favorite-btn");

            buttons.forEach(btn => {
                if (list.some(m => m.slug === btn.dataset.slug)) {
                    btn.classList.add("saved");
                    btn.innerText = "‚úì";
                }
            });
        });
        function updateFavoriteButtons() {
            const list = getMyList();
            const buttons = document.querySelectorAll(".favorite-btn");

            buttons.forEach(btn => {
                if (list.some(m => m.slug === btn.dataset.slug)) {
                    btn.classList.add("saved");
                    btn.innerText = "‚úì";
                } else {
                    btn.classList.remove("saved");
                    btn.innerText = "+";
                }
            });
        }
    </script>
    <div id="toast" class="toast"></div>

    <script>
    function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        toast.className = "toast show " + type;
        toast.innerText = message;

        setTimeout(() => {
            toast.className = "toast";
        }, 2500);
    }

    </script>
    </body>
</html>

