@{
    Layout = null;
    int current = ViewBag.CurrentPage ?? 1;
    int total = ViewBag.TotalPages ?? 1;

    int start = Math.Max(1, current - 2);
    int end = Math.Min(total, current + 2);
}
@model List<MovieItem>

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Movie+</title>
    <link rel="stylesheet" href="/css/movie.css" />
    <link rel="stylesheet" href="/css/continue-watching.css" />
</head>
<body>

    @Html.Partial("_Header")

    <!-- Continue Watching Section -->
    <div class="continue-watching-section" id="continueWatchingSection">
        <h2>Đang Xem</h2>
        <div class="cw-scroll" id="cwScroll">
            <!-- JS will render cards here -->
        </div>
    </div>

    <form method="get" action="/Movie" class="filter-form">

        <select name="category">
            <option value="">-- Thể loại --</option>

            @foreach (var item in (List<CategoryItem>)ViewBag.Categories)
            {
                <option value="@item.slug"
                        selected="@(ViewBag.Category == item.slug)">
                    @item.name
                </option>
            }
        </select>


        <select name="country">
            <option value="">-- Quốc gia --</option>

            @foreach (var item in (List<CategoryItem>)ViewBag.Countries)
            {
                <option value="@item.slug"
                        selected="@(ViewBag.Country == item.slug)">
                    @item.name
                </option>
            }
        </select>

        <select name="year">
            <option value="">-- Năm --</option>

            @foreach (var y in (List<int>)ViewBag.Years)
            {
                <option value="@y"
                        selected="@(ViewBag.Year == y.ToString())">
                    @y
                </option>
            }
        </select>

        <button type="submit">Lọc</button>
    </form>

    <h2>
        @if(ViewBag.Keyword != null)
        {
            <text>Kết quả tìm kiếm: "@ViewBag.Keyword"</text>
        }
        else
        {
            <text>Danh sách phim</text>
        }
    </h2>


    <div class="movie-container">
        @foreach (var movie in Model)
        {
            <div class="movie-card">
                <a href="/Movie/Detail/@movie.slug">
                    <img src="https://img.ophim.live/uploads/movies/@movie.poster_url"
                         onerror="this.src='https://placehold.co/300x450?text=No+Image'" />
                </a>

                <div class="movie-info">
                    <h4>@movie.name</h4>
                    <p>@movie.year</p>
                </div>
            </div>
        }
    </div>

    <div class="pagination">
        @if (current > 1)
        {
            <a class="page-nav"
            asp-controller="Movie"
            asp-action="Index"
            asp-route-page="@(current - 1)"
            asp-route-category="@ViewBag.Category"
            asp-route-country="@ViewBag.Country"
            asp-route-year="@ViewBag.Year">
            « Trước
            </a>
        }

        <!-- Trang 1 -->
        @if (start > 1)
        {
            <a class="page-number"
            asp-controller="Movie"
            asp-action="Index"
            asp-route-page="1"
            asp-route-category="@ViewBag.Category"
            asp-route-country="@ViewBag.Country"
            asp-route-year="@ViewBag.Year"
            asp-route-keyword="@ViewBag.Keyword">
                1
            </a>


            @if (start > 2)
            {
                <span class="page-dots">...</span>
            }
        }

        <!-- Các trang giữa -->
        @for (int i = start; i <= end; i++)
        {
            if (i == current)
            {
                <span class="page-number active">@i</span>
            }
            else
            {
                <a class="page-number"
                asp-controller="Movie"
                asp-action="Index"
                asp-route-page="@i"
                asp-route-category="@ViewBag.Category"
                asp-route-country="@ViewBag.Country"
                asp-route-year="@ViewBag.Year"
                asp-route-keyword="@ViewBag.Keyword">
                @i
                </a>
            }
        }

        <!-- Trang cuối -->
        @if (end < total)
        {
            @if (end < total - 1)
            {
                <span class="page-dots">...</span>
            }

            <a class="page-number"
            asp-controller="Movie"
            asp-action="Index"
            asp-route-page="@total"
            asp-route-category="@ViewBag.Category"
            asp-route-country="@ViewBag.Country"
            asp-route-year="@ViewBag.Year"
            asp-route-keyword="@ViewBag.Keyword">
            @total
            </a>

        }

        @if (current < total)
        {
            <a class="page-nav"
            asp-controller="Movie"
            asp-action="Index"
            asp-route-page="@(current + 1)"
            asp-route-category="@ViewBag.Category"
            asp-route-country="@ViewBag.Country"
            asp-route-year="@ViewBag.Year"
            asp-route-keyword="@ViewBag.Keyword">
            Sau »
            </a>
        }

    </div>


    @Html.Partial("_Footer")

    <script>
    // ===== CONTINUE WATCHING — Render from localStorage =====
    document.addEventListener('DOMContentLoaded', function () {
        renderContinueWatching();
    });

    function renderContinueWatching() {
        const section = document.getElementById('continueWatchingSection');
        const scroll = document.getElementById('cwScroll');
        const history = getWatchHistory();

        if (!history || history.length === 0) {
            section.classList.remove('has-items');
            return;
        }

        section.classList.add('has-items');
        scroll.innerHTML = '';

        // Sort by most recently watched
        history.sort((a, b) => b.timestamp - a.timestamp);

        history.forEach(function (item, idx) {
            const card = document.createElement('a');
            card.href = '/Movie/Detail/' + item.slug;
            card.className = 'cw-card';

            // Fake progress bar (random between 15% and 85% to look realistic)
            const progress = item.progress || Math.floor(Math.random() * 70 + 15);

            card.innerHTML =
                '<div class="cw-thumb">' +
                    '<img src="' + item.poster + '" onerror="this.src=\'https://placehold.co/400x225?text=No+Image\'" alt="' + escapeHtml(item.name) + '" />' +
                    '<div class="cw-play-overlay"></div>' +
                    '<span class="cw-episode-badge">Tập ' + escapeHtml(item.episodeName) + '</span>' +
                    '<div class="cw-progress"><div class="cw-progress-bar" style="width: ' + progress + '%"></div></div>' +
                '</div>' +
                '<div class="cw-info">' +
                    '<h4>' + escapeHtml(item.name) + '</h4>' +
                    '<p>' + (item.year || '') + '</p>' +
                    '<div class="cw-time">' + timeAgo(item.timestamp) + '</div>' +
                '</div>' +
                '<button class="cw-remove" data-slug="' + item.slug + '" title="Xóa khỏi lịch sử" onclick="removeCWItem(event, \'' + item.slug + '\')">✕</button>';

            scroll.appendChild(card);
        });
    }

    function getWatchHistory() {
        try {
            return JSON.parse(localStorage.getItem('watchHistory')) || [];
        } catch (e) {
            return [];
        }
    }

    function removeCWItem(e, slug) {
        e.preventDefault();
        e.stopPropagation();
        let history = getWatchHistory();
        history = history.filter(item => item.slug !== slug);
        localStorage.setItem('watchHistory', JSON.stringify(history));
        renderContinueWatching();
    }

    function timeAgo(ts) {
        const diff = Date.now() - ts;
        const mins = Math.floor(diff / 60000);
        if (mins < 1) return 'Vừa xong';
        if (mins < 60) return mins + ' phút trước';
        const hours = Math.floor(mins / 60);
        if (hours < 24) return hours + ' giờ trước';
        const days = Math.floor(hours / 24);
        if (days < 7) return days + ' ngày trước';
        return Math.floor(days / 7) + ' tuần trước';
    }

    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    </script>

</body>
</html>

