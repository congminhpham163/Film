@inject FilmService FilmSvc
@{
    var headerCategories = await FilmSvc.GetCategories();
    var headerCountries  = await FilmSvc.GetCountries();
    var sortedCats = headerCategories.OrderBy(c => c.name).ToList();
    var sortedCnts = headerCountries.OrderBy(c => c.name).ToList();
    var kw = Context.Request.Query["keyword"].ToString();
}

<link rel="stylesheet" href="/css/header.css" />

<header class="main-header">

    <div class="menu-toggle" onclick="toggleMenu(event)">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <script>
    window.toggleMenu = function(e){
        e?.stopPropagation();

        document.querySelector(".header-nav")
            .classList.toggle("open");
    }
    </script>

    <!-- LOGO -->
    <div class="logo">
        <a href="/Movie">MOVIE+</a>
    </div>

    <!-- NAV -->
    <nav class="header-nav">
        <a href="/Movie" class="nav-link">Trang Chủ</a>
        <a href="/Movie?type=series&showAll=true" class="nav-link">Phim Bộ</a>
        <a href="/Movie?type=single&showAll=true" class="nav-link">Phim Lẻ</a>
        <a href="/Movie?category=hoathinh" class="nav-link">Hoạt Hình</a>

        <!-- Thể Loại dropdown -->
        <div class="nav-dropdown">
            <span class="nav-link dropdown-trigger">
                Thể Loại <span class="arrow">▾</span>
            </span>
            <div class="dropdown-menu">
                @foreach (var cat in sortedCats)
                {
                    <a href="/Movie?category=@cat.slug" class="dropdown-item">@cat.name</a>
                }
            </div>
        </div>

        <!-- Quốc Gia dropdown -->
        <div class="nav-dropdown">
            <span class="nav-link dropdown-trigger">
                Quốc Gia <span class="arrow">▾</span>
            </span>
            <div class="dropdown-menu">
                @foreach (var cnt in sortedCnts)
                {
                    <a href="/Movie?country=@cnt.slug" class="dropdown-item">@cnt.name</a>
                }
            </div>
        </div>

        <a href="/Movie?showAll=true" class="nav-link">Tất cả phim</a>
    </nav>

    <!-- SEARCH -->
    <div class="header-search">
        <form method="get" action="/Movie/Index" class="search-form">

            <button type="button" class="search-toggle">
                <img src="/icons/find.png" />
            </button>

            <div class="search-box">
                <input type="text"
                    name="keyword"
                    value="@kw"
                    placeholder="Tìm phim..." />
            </div>

        </form>

    </div>
</header>

<script>
    /* SEARCH */
    (function () {
        // Click trigger → toggle .open; click outside → close all
        document.querySelectorAll('.nav-dropdown .dropdown-trigger').forEach(trigger => {
            trigger.addEventListener('click', function (e) {
                e.stopPropagation();
                const parent = this.closest('.nav-dropdown');
                const isOpen = parent.classList.contains('open');

                // Close all dropdowns first
                document.querySelectorAll('.nav-dropdown').forEach(d => d.classList.remove('open'));

                // Toggle the clicked one
                if (!isOpen) parent.classList.add('open');
            });
        });

        // Click outside → close all
        document.addEventListener('click', function () {
            document.querySelectorAll('.nav-dropdown').forEach(d => d.classList.remove('open'));
        });

        // Prevent clicks inside the menu from closing it
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.addEventListener('click', function (e) {
                e.stopPropagation();
            });
        });
    })();


    const search = document.querySelector(".header-search");
    const toggle = document.querySelector(".search-toggle");
    const form   = document.querySelector(".search-form");
    const input  = document.querySelector(".search-box input");

    toggle.addEventListener("click",(e)=>{

        /* Nếu chưa mở → mở search */
        if(!search.classList.contains("open")){
            e.preventDefault();
            search.classList.add("open");
            input.focus();
            return;
        }

        /* Nếu đã mở → submit */
        if(input.value.trim() !== ""){
            form.submit();
        }else{
            input.focus();
        }
    });

    /* click trong search không đóng */
    search.addEventListener("click",(e)=>{
        e.stopPropagation();
    });

    /* click ngoài đóng */
    document.addEventListener("click",()=>{
        search.classList.remove("open");
    });

    /* ESC đóng */
    document.addEventListener("keydown",(e)=>{
        if(e.key === "Escape"){
            search.classList.remove("open");
        }
    });

</script>
